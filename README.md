# Internal API for validating NTAG 424 DNA message

This is an API that allows to decrypt and validate dynamic URL parts generated by NTAG 424 DNA tags.

## Examples
### Successful validation
Request:
```
GET /api/validate?enc=DFCD2C8A6F4A85D532B1C2377E33C12CAD3F471A44EC530DFA3C3C5AFC8FA53A1D7F4D986E052D20FA228F58469C987D9A23225B15224415
```

Response (JSON):
```
{'valid': True, 'tag': {'uid': '04273C8A2D6B80', 'read_ctr': 6, 'tt_status': 'not_supported'}
```

### Unsuccessful validation
Request:
```
GET /api/validate?enc=22222F9FBBBA0671CA833C11E7B0326511A888BC39BB01CC76E74F85A668211DC31BEA35F15E325EA2AB14820E946F0F16B868C4C9122222
```

Response (JSON):
```
{'valid': False, 'tag': None}
```

## Installation

```
apt-get install -y python3 python3-pip
pip3 install -r requirements.txt
cp config.dist.py config.py
# TODO adjust settings in config.py
```

## Configuration

| Key           | Description               |
| ------------- | ------------------- |
| `MASTER_KEY` | Master keys for derivation. Should be set to random 16 byte values (hex encoded). |
| `TAG_HASH_KEY` | Key for derivation of "tag hashes". Should be set to random 16 byte values (hex encoded). |
| `TAG_SECRET_KEY` | Key for derivation of "tag secrets". Should be set to random 16 byte values (hex encoded). |
| `PBKDF_ROUNDS` | Number of rounds used for key derivation. |
| `ENABLE_DEMO` | Whether to enable `/demo` endpoint. |

## Docker usage
```
sudo docker build -t nfc-api .
sudo docker run \
    -e NFC_MASTER_KEY_0=d4787e885637c02c1333518846b2629e \
    -e NFC_MASTER_KEY_1=7a5037005d55e31ed9c99c45a2614f48 \
    -e NFC_MASTER_KEY_2=1c2ae7f57341a520a7d4bbf5be7a805b \
    -e NFC_MASTER_KEY_3=4fdf0fc1e1125de5b98701cf7ce98aef \
    -e NFC_MASTER_KEY_4=a1928a184d4e7393628af81803d1beac \
    -e NFC_TAG_HASH_KEY=b57bcd4a8a8499624858f2dc5b19ef02 \
    -e NFC_TAG_SECRET_KEY=c952c99d41713968dee6ca1c2a63a412 \
    -e NFC_PBKDF_ROUNDS=1000 \
    -e NFC_ENABLE_DEMO=YES \
    -p 80:8080 \
    -it nfc-api
```


## Google Cloud Usage

Create Continuous Deployment for Container:
  - https://cloud.google.com/build/docs/securing-builds/configure-access-for-cloud-build-service-account
  - https://cloud.google.com/build/docs/automating-builds/create-manage-triggers
  - https://cloud.google.com/run/docs/quickstarts/deploy-continuously

  - Navigate to Google Cloud Run
    - https://console.cloud.google.com/run?authuser=0&hl=en&project=taggr-admin-staging

  - Create Service
    - Select "Continuously deploy new revisions from a source repository"
      - Click "Set up with cloud build"
        - Connect to Github
        - Select Repository "tag-setup-backend-docker"
        - Select a Branch "main" or "staging"
        - Build Type: Dockerfile
        - Source location: /Dockerfile
      - Click "Save"
    - Service Name: "[client-id]-tag-writer-ci"
    - Region: us-central1
    - Select "Allow unauthenticated invocations"
    - Open the "Container, Networking, Security" section
      - Under "Container" tab:
        - Add Env Vars for App
    - Click "Create"

    At this point the build will likely fail, if so:
    - Click "Edit Continuous Deployment" button at the top
    - Set Region to "us-central1"
    - Set Configuration Type to "Dockerfile"
    - Set the Dockerfile name input box explicitly to "Dockerfile"
    - Edit the Image Name to be less than 100 chars (use $SHORT_SHA at the end)
    - Uncheck the option "Send build logs to Github"
    - Clear the "Service account email" field in order to use the default Cloud Build Service Account
    - Click "Save"

  If the Service is not being updated by the Trigger:
    - Ensure the Service has the correct "Label" for the Trigger
      - Find the Trigger ID (not name)
        - Go to Cloud Build -> History
        - Find the last Build that succeeded from the Trigger
        - Click on the Build ID link
        - Open the "Execution Details" tab
        - Find the Trigger ID and copy
      - Go to Cloud Run
        - Check the checkbox beside the Service
        - on the right side of the screen a panel will open for "permissions" and "labels"
        - Click the "labels" tab
          - edit the "gcb-trigger-id" and paste the Trigger ID from above
          - edit the "gcb-trigger-region" to be "us-central1"
          - click "Save"
      The service should now auto-update to the correct container image

  - Run the Trigger to Test
